<!DOCTYPE html>
<html>
<head>


<style>
#info {
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  overflow: hidden;
}

</style>
</head>

<body> 


</body>
<br>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>

<h1> Homework 6 (<a href="http://jsfiddle.net/qaad1234/rcL1rLtg/"> jsfiddle </a>)</h1>
<h1> Homework 6 (<a href="https://docs.google.com/presentation/d/1PpSdcWzN0sYPoqfHkoRC23n9P9m6IpRFFVH69ANhAaY/edit?usp=sharing"> PPT </a>)</h1>

<hr>
<div id="container" style="float:left; margin:3px; width:35vw; height:35vw">
</div>
<div style="float:left; margin-left: 10px; width:32vw;">
  <br>
  <button id="play" style="width:100%">Playback </button>
  <br>
  <br>
  <button id="clear" style="width:100%">Clear </button>
  <br>
  <br>
  <button id="save" style="width:100%">Save</button>
  <br><br>
  <button id="restore" style="width:100%">Restore </button>
  <br>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

<script>
var camera, scene, renderer, mesh, light, controls;


///////////////////////////////////////////////////////
var camera, scene, renderer, controls;
var floor;

var logs = [];
var ti = [];
var xyi = [];
var firstPick = true;
var isMoving = false;
var move;
var moveStart;

var startTime = new Date().getTime();
var pos = {
  '1': [-30, -10],
  '2': [-10, -20],
  '3': [-10, -35],
  '4': [-5, 10],
  '5': [-5, 30],
  '6': [30, 30],
  '7': [30, 10]
}
var pickables = [];
var mouse = new THREE.Vector2();
var raycaster = new THREE.Raycaster();
var pick;

$('#save').click(function() {
  console.log(JSON.stringify(logs));

  localStorage.setItem('activity', JSON.stringify(logs));
});

$('#play').click(function() {
  startPlayback();
});

$('#clear').click (function() {
	ti = [];
  xyi = [];
  logs = [];
  firstPick = true;
  move.material.visible = false;
});

$('#restore').click (function() {
	logs = JSON.parse (localStorage.getItem ('activity'));
});

function startPlayback () {
	if (logs.length === 0)
  	return;
    
	for (var i = 0; i < logs.length; i++) {
  	ti.push (logs[i].dt);
    xyi.push (pos[ logs[i].code]);
  }
  isMoving = true;
  move.material.visible = true;
  moveStart = new Date().getTime();
  
}

///////////////////////////////////////////////////////
init();
animate();

  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(ww, hh);
  renderer.setClearColor(0x888888);
  $("#container").append(renderer.domElement);

  ////////////////////////////////////////////////



function texturedFace(url, x, y) {
  var geometry = new THREE.BoxGeometry(x, y, 0.1);
  geometry.vertices.push(
    new THREE.Vector3(-50, 50, 0),
    new THREE.Vector3(-50, -50, 0),
    new THREE.Vector3(50, -50, 0),
    new THREE.Vector3(50, 50, 0)
  );

  var face;
  face = new THREE.Face3(0, 1, 2);
  face.materialIndex = 0;
  geometry.faces.push(face);
  face = new THREE.Face3(0, 2, 3);
  face.materialIndex = 0;
  geometry.faces.push(face);

  geometry.faceVertexUvs[0].push([new THREE.Vector2(0, 1), new THREE.Vector2(0, 0), new THREE.Vector2(1, 0)]);
  geometry.faceVertexUvs[0].push([new THREE.Vector2(0, 1), new THREE.Vector2(1, 0), new THREE.Vector2(1, 1)]);
  geometry.computeBoundingSphere();
  geometry.computeFaceNormals();
  geometry.computeVertexNormals();
  // CORS:
  // http://stackoverflow.com/questions/24087757/three-js-and-loading-a-cross-domain-image
  THREE.ImageUtils.crossOrigin = '';
  texture = THREE.ImageUtils.loadTexture(url);
  texture.wrapS = THREE.RepeatWrapping;
  texture.wrapT = THREE.RepeatWrapping;
  texture.minFilter = THREE.LinearFilter;
  return new THREE.Mesh(geometry,
    new THREE.MeshBasicMaterial({
      map: texture,
      side: THREE.DoubleSide
    }));


}

function loadTexture(url) {

  // instantiate a loader
  var loader = new THREE.TextureLoader();

  loader.setCrossOrigin('');

  // load a resource
  loader.load(
    // resource URL
    url, // Lena
    // Function when resource is loaded
    function(tex) {
      console.log('texture loaded ...');

      texture = tex; // for global access with Keypress
    },

    // Function called when download progresses
    function(xhr) {
      console.log((xhr.loaded / xhr.total * 100) + '% loaded');
    },
    // Function called when download errors
    function(xhr) {
      console.log('An error happened');
    }
  );

}



function init() {

  

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(12, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.z = 500;
  scene.add(camera);
  

  light = new THREE.PointLight(0xffffff);
  light.position.set(100, 300, 200);
  scene.add(light);

  /*var gridXZ = new THREE.GridHelper(100, 10, 'red', 'white');
  scene.add(gridXZ);
  // gridXZ.position.set (25,0,25);

  var axes = new THREE.AxisHelper(25);
  scene.add(axes);*/

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);

  controls = new THREE.OrbitControls(camera, renderer.domElement);

  //document.body.appendChild(renderer.domElement);
  

  var geometry = new THREE.CircleGeometry(2, 32);
  var material = new THREE.MeshBasicMaterial();
  var circle = new THREE.Mesh(geometry, material);

  addLoc(0x0000ff, pos['1'][0], pos['1'][1], '1');
  addLoc(0x00ff00, pos['2'][0], pos['2'][1], '2');
  addLoc(0x00ffff, pos['3'][0], pos['3'][1], '3');
  addLoc(0xff0000, pos['4'][0], pos['4'][1], '4');
  addLoc(0xff00ff, pos['5'][0], pos['5'][1], '5');
  addLoc(0xffff00, pos['6'][0], pos['6'][1], '6');
  addLoc(0x888888, pos['7'][0], pos['7'][1], '7');

  function addLoc(hexColor, x, y, name) {
    var cc = circle.clone();
    cc.material = new THREE.MeshBasicMaterial({
      color: hexColor
    });
    cc.position.set(x, y, 10);
    scene.add(cc);
    cc.name = name;
    pickables.push(cc);
  }

  move = new THREE.Mesh (new THREE.CircleGeometry (1.4, 6), new THREE.MeshBasicMaterial({color:0xaaaa00}));
  scene.add (move);
  move.material.visible = false;
  
  pick = new THREE.Mesh (new THREE.RingGeometry (2, 3, 32), new THREE.MeshBasicMaterial({color:0xefc9ed}));
  scene.add (pick);
  pick.material.visible = false;

  
  window.addEventListener('resize', onWindowResize, false);
  window.addEventListener('mousedown', onDocumentMouseDown, false);
  window.addEventListener('mouseup', onDocumentMouseUp, false);

  console.log(startTime);
//}

  ////////////////////////////////////////////////////////////////////////


  var geometry = new THREE.PlaneGeometry(88, 94);
  var material = new THREE.MeshBasicMaterial({
    color: 0x444444,
    side: THREE.DoubleSide
  });

  var ground = new THREE.Mesh(geometry, material);
  scene.add(ground);
  //////////////////////////////////////////////////
  var geometry1 = new THREE.PlaneGeometry(25, 31);
  var material1 = new THREE.MeshBasicMaterial({
    color: 0x888888,
    side: THREE.DoubleSide
  });
  
  var ground2 = new THREE.Mesh(geometry1, material1);
  ground2.position.set(-31.5, 31.5, 0);
  scene.add(ground2);
  
  var newwhite1 = ground2.clone();
  scene.add(newwhite1);
  newwhite1.position.set(-31.5, -32, 0);
  
  var newwhite2 = ground2.clone();
  scene.add(newwhite2);
  newwhite2.position.set(31.5, -32, 0);
  
  //////////////////////////////////////////////////////
  P1 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 31);
  P1.position.set(-44, 0, 12.5);  
  P1.rotation.y = Math.PI / 2;
  scene.add(P1);
  
  P2 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P2.position.set(-31.5, 15.5, 12.5);  
  P2.rotation.x = Math.PI / 2;
  scene.add(P2);
  
  P3 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P3.position.set(-31.5, -15.5, 12.5);  
  P3.rotation.x = Math.PI / 2;
  scene.add(P3);
  
  P4 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 31);
  P4.position.set(-19, -31, 12.5);  
  P4.rotation.y = Math.PI / 2;
  scene.add(P4);
  
  P5 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 31);
  P5.position.set(19, -31, 12.5);  
  P5.rotation.y = Math.PI / 2;
  scene.add(P5);
  
  P6 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P6.position.set(31.5, -15.5, 12.5);  
  P6.rotation.x = Math.PI / 2;
  scene.add(P6);
  
  P7 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 38, 25);
  P7.position.set(0, -46.7, 12.5);  
  P7.rotation.x = Math.PI / 2;
  scene.add(P7);
  
  P8 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P8.position.set(-6.5, 46.7, 12.5);  
  P8.rotation.x = Math.PI / 2;
  scene.add(P8);
  
  P9 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 50);
  P9.position.set(-19, 21.5, 12.5);  
  P9.rotation.y = Math.PI / 2;
  scene.add(P9);
  
  P10 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 62);
  P10.position.set(44, 15.5, 12.5);  
  P10.rotation.y = Math.PI / 2;
  scene.add(P10);
  
  P11 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P11.position.set(31.5, 46.7, 12.5);  
  P11.rotation.x = Math.PI / 2;
  scene.add(P11);
  
  P12 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P12.position.set(-6.5,23.5, 12.5);  
  P12.rotation.x = Math.PI / 2;
  scene.add(P12);
  
  P13 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 25);
  P13.position.set(-6.5,-3.5, 12.5);  
  P13.rotation.x = Math.PI / 2;
  scene.add(P13);
  
  P14 = texturedFace('http://i.imgur.com/DrvlmNW.jpg', 25, 50);
  P14.position.set(6, 21.5, 12.5);  
  P14.rotation.y = Math.PI / 2;
  scene.add(P14);
}
////////////////////////////////////////////
function onDocumentMouseDown(event) {

  event.preventDefault();
  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  var intersects = raycaster.intersectObjects(pickables);
  if (intersects.length > 0) {
  
  console.log (intersects[0].object.name);
  
  	pick.material.visible = true;
    var xy = pos[intersects[0].object.name];
    pick.position.x = xy[0];
    pick.position.y = xy[1];
    pick.position.z = 3;  // important: set above the floor plan
    
  	if (firstPick) {
    	firstPick = false;
      startTime = new Date().getTime();
      dt = 0;
    } else {
    	dt = new Date().getTime() - startTime;
    }
    var record = {
      dt: dt,
      code: intersects[0].object.name
    };
    logs.push(record);
  }

}

function onWindowResize() {

  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();

  camera.aspect = ww / hh;
  camera.updateProjectionMatrix();
  renderer.setSize(ww, hh);

}
/////////////////////////////////////////
function onDocumentMouseUp () {
	pick.material.visible = false;
}

function onDocumentMouseDown(event) {

  event.preventDefault();
  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  var intersects = raycaster.intersectObjects(pickables);
  if (intersects.length > 0) {
  
  console.log (intersects[0].object.name);
  
  	pick.material.visible = true;
    var xy = pos[intersects[0].object.name];
    pick.position.x = xy[0];
    pick.position.y = xy[1];
    pick.position.z = 3;  // important: set above the floor plan
    
  	if (firstPick) {
    	firstPick = false;
      startTime = new Date().getTime();
      dt = 0;
    } else {
    	dt = new Date().getTime() - startTime;
    }
    var record = {
      dt: dt,
      code: intersects[0].object.name
    };
    logs.push(record);
  }

}

function onWindowResize() {

  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();

  camera.aspect = ww / hh;
  camera.updateProjectionMatrix();
  renderer.setSize(ww, hh);

}



///////////////////////////////////////////

function animate() {

  requestAnimationFrame(animate);
  render();
  
  if (isMoving) {
  	t = new Date().getTime() - moveStart;
    if (t > logs[logs.length-1].dt) {
    	isMoving = false;
      return;
    }
    var mov = interpolate (t);
    move.position.x = mov[0];
    move.position.y = mov[1];
    move.position.z = 10;
  }
  
  function interpolate(t) {
  	for (var i = 0; i < ti.length; i++) {
    	if (t < ti[i]) break;
    }
    var s = (t - ti[i-1])/(ti[i] - ti[i-1]);
    var x = (1-s)*xyi[i-1][0] + s*xyi[i][0];
    var y = (1-s)*xyi[i-1][1] + s*xyi[i][1];
    return [x,y];
  }

}

function render() {
  renderer.render(scene, camera);
}

// important to add this 
// in jsfiddle!
window.focus();


</script>
</body>

</html>